From c5d11a776e536a3c37500cb155003b8c62a58a43 Mon Sep 17 00:00:00 2001
From: Eric Squires <eric.g.squires@gmail.com>
Date: Sun, 8 Apr 2018 23:08:22 -0400
Subject: [PATCH] open tag in reverse_goto when indicated by switchbuf

---
 autoload/vimtex/index.vim        | 15 ++++++---------
 autoload/vimtex/view.vim         | 14 +++++++-------
 autoload/vimtex/view/zathura.vim |  2 +-
 3 files changed, 14 insertions(+), 17 deletions(-)

diff --git a/autoload/vimtex/index.vim b/autoload/vimtex/index.vim
index b6fa9e2..6eb4fef 100644
--- a/autoload/vimtex/index.vim
+++ b/autoload/vimtex/index.vim
@@ -165,21 +165,18 @@ function! s:index.activate(close) abort dict "{{{1
   "   the &switchbuf option to either 'useopen' or 'usetab'
   let cmd = 'buffer! '
   if &switchbuf =~# 'usetab'
-    for i in range(tabpagenr('$'))
-      if index(tabpagebuflist(i + 1), bnr) >= 0
-        let cmd = 'sbuffer! '
-        break
-      endif
-    endfor
+    let f = resolve(entry.file)
+    if tags#Look_for_matching_tab(f) == 0
+        execute 'tabnew ' . f
+    endif 
+
   elseif &switchbuf =~# 'useopen'
     if bufwinnr(bnr) > 0
       let cmd = 'sbuffer! '
+      execute 'keepalt' cmd bnr
     endif
   endif
 
-  " Open file buffer
-  execute 'keepalt' cmd bnr
-
   " Go to entry line
   if has_key(entry, 'line')
     call vimtex#pos#set_cursor(entry.line, 0)
diff --git a/autoload/vimtex/view.vim b/autoload/vimtex/view.vim
index f27b2a8..3627863 100644
--- a/autoload/vimtex/view.vim
+++ b/autoload/vimtex/view.vim
@@ -69,18 +69,17 @@ function! vimtex#view#reverse_goto(line, filename) " {{{1
 
   if !bufexists(l:file)
     if filereadable(l:file)
-      execute 'silent edit' l:file
+      if &switchbuf =~# 'usetab'
+        execute 'tabedit ' . l:file
+      else 
+        execute 'silent edit' l:file
+      endif 
     else
       call vimtex#log#warning("Reverse goto failed for file:\n" . l:file)
       return
     endif
   endif
-
-  let l:bufnr = bufnr(l:file)
-  let l:winnr = bufwinnr(l:file)
-  execute l:winnr >= 0
-        \ ? l:winnr . 'wincmd w'
-        \ : 'buffer ' . l:bufnr
+  call tags#Look_for_matching_tab(l:file)
 
   execute 'normal!' a:line . 'G'
   normal! zMzvzz
@@ -101,4 +100,5 @@ function! vimtex#view#reverse_goto(line, filename) " {{{1
   endif
 endfunction
 
+command! -nargs=+ VimtexReverseGoto :call vimtex#view#reverse_goto(<f-args>)<cr>
 " }}}1
diff --git a/autoload/vimtex/view/zathura.vim b/autoload/vimtex/view/zathura.vim
index cbea75b..9a8d061 100644
--- a/autoload/vimtex/view/zathura.vim
+++ b/autoload/vimtex/view/zathura.vim
@@ -110,7 +110,7 @@ function! s:zathura.latexmk_append_argument() dict " {{{1
           \ 'zathura ' . g:vimtex_view_zathura_options
           \ . ' -x \"' . g:vimtex_compiler_progname
           \ . ' --servername ' . v:servername
-          \ . ' --remote +\%{line} \%{input}\" \%S')
+          \ . ' -c VimtexReverseGoto\\ \%{line}\\ \%{input}\" \%S')
   endif
 
   return cmd
-- 
2.7.4

